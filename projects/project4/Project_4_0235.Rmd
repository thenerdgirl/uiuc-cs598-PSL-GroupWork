---
title: "Project 4: Movie Recommender System"
subtitle: "CS598: Practical Statistical Learning"
author: 
 - name: Naomi Bhagat - nbhagat3
 - name: Michael Miller - msmille3
 - name: Joe May - jemay3
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    theme: readable
    toc: yes
urlcolor: cyan
---

# Assignment Data
Program: MCS-DS  
Team contributions:

| Person         | Contribution |
|----------      |----------|
| Naomi Bhagat   | Application |
| Michael Miller | System 1 |
| Joe May        | System 2  |

Assignment URL: [campuswire post](https://liangfgithub.github.io/Proj/F23_Proj4.html)

```{r setup, eval = TRUE}
# add required packages
packages = c('tidyverse')

# if packages don't exist, install. Then call library on them
for (package in packages) {
  if (!requireNamespace(package, quietly=TRUE)) {
    install.packages(package)
  }
  library(package, character.only=TRUE)
}

# set seed
set.seed(235)

# download and preprocses raw movie data
# note that this code is from example code from this class 
# https://liangfgithub.github.io/Rcode_W13_Movie_EDA.nb.html

source_url = "https://liangfgithub.github.io/MovieData/"

ratings = read.csv(paste0(source_url, 'ratings.dat?raw=true'), 
                   sep = ':',
                   colClasses = c('integer', 'NULL'), 
                   header = FALSE)

colnames(ratings) = c('UserID', 'MovieID', 'Rating', 'Timestamp')

# load movies. Same source
movies = readLines(paste0(source_url, 'movies.dat?raw=true'))
movies = strsplit(movies, split = "::", fixed = TRUE, useBytes = TRUE)
movies = matrix(unlist(movies), ncol = 3, byrow = TRUE)
movies = data.frame(movies, stringsAsFactors = FALSE)
colnames(movies) = c('MovieID', 'Title', 'Genres')
movies$MovieID = as.integer(movies$MovieID)

# convert accented characters
movies$Title = iconv(movies$Title, "latin1", "UTF-8")

# extract year
movies$Year = as.numeric(unlist(
  lapply(movies$Title, function(x) substr(x, nchar(x)-4, nchar(x)-1))))

# 
users = read.csv(paste0(source_url, 'users.dat?raw=true'),
                 sep = ':', header = FALSE)
users = users[, -c(2,4,6,8)] # skip columns
colnames(users) = c('UserID', 'Gender', 'Age', 'Occupation', 'Zip-code')
```



# System I: Recommendation Based on Genres

We propose the following genre-based recommendation system. A human-readable description of the system is provided first, with implementation in r below. This section of the report generates a csv file that will be used directly by the application to make recommendation.


## Considerations
Goals 
Show users movies that are good
Get more reviews 


1. Recommend 'good' movies. Define good 

2. Add in some highly rated by not very well reviewed movies

3. Add in a small number of not very well reviewed movies 


## Limitations
Algorithm implemented without feedback
Algorithm is static

In real world setting, would try to get additional reviews from users. Would recalculate recommendations each time so that users see new recommendations. A good strategy might be: once a user 'selects' a movie, to replace it with a new recommendation, or provide some kind of shuffle button for the user to reset recommendations. 

# Implementation 
```{r ingest_data, eval = TRUE}
# define the mixture of movies we're going to take
n_all_time_fav = 50
n_most_popular = 40
n_hidden = 10
n_total_recs = 10

# define params for establishing popular movies vs hidden gems
min_reviews_popular = 100
min_reviews_hidden = 5

# first, unpack and duplicate genres so that each movie-genre combo is one row
movie_genres = movies %>% 
  mutate(Genres = strsplit(Genres, '\\|')) %>%
  rename(Genre = Genres) %>%
  unnest(Genre)

genres = unique(movie_genres$Genre)

# get total 5 star review counts
perfect_reviews = ratings %>%
  filter(Rating == 5) %>%
  group_by(MovieID) %>%
  summarize(PerfectReviews = n())

# get average review for popular movies
review_percent_popular = ratings %>%
  group_by(MovieID) %>%
  filter(n() >= min_reviews_popular) %>%
  summarize(AvgRating = mean(Rating))
  
# get average reviewfor rising movies 
review_percent_hidden = ratings %>%
  group_by(MovieID) %>%
  filter(n() >= min_reviews_hidden) %>%
  filter(n() < min_reviews_popular) %>%
  summarize(AvgRating = mean(Rating))

# join perfect reviews with movie genres, take top n to get all time favorite movies
all_time_favorites = movie_genres %>%
  inner_join(perfect_reviews, by="MovieID") %>%
  arrange(desc(PerfectReviews)) %>%
  group_by(Genre) %>%
  slice_head(n=n_all_time_fav)

all_time_favorites['Rationale'] = 'All time favorite'

out = all_time_favorites[c('MovieID', 'Title', 'Genre', 'Year', 'Rationale')]

# join average review with movie genres, take top n to get popular movies
# note we are excluding any movie that might already be all time favorites
popular = movie_genres %>%
  anti_join(out, by="MovieID") %>%
  inner_join(review_percent_popular, by="MovieID") %>%
  arrange(desc(AvgRating)) %>%
  group_by(Genre) %>%
  slice_head(n=n_most_popular)
popular['Rationale'] = 'Popular'

out = bind_rows(out, popular[c('MovieID', 'Title', 'Genre', 'Year', 'Rationale')])

# join average rising reviews with movie genres, take top n to get rising movies
# note we are exlucuding any movies already chosen
hidden = movie_genres %>%
  anti_join(out, by="MovieID") %>%
  inner_join(review_percent_hidden, by="MovieID") %>%
  arrange(desc(AvgRating)) %>%
  group_by(Genre) %>%
  slice_head(n=n_hidden)
hidden['Rationale'] = 'Hidden gem'

out = bind_rows(out, hidden[c('MovieID', 'Title', 'Genre', 'Year', 'Rationale')])

# next, we randomly sample 10 films from out for each genre, and we save these for use in the app
to_csv = out %>%
  arrange(sample(n())) %>%
  group_by(Genre) %>%
  slice_head(n=n_total_recs)
  
write_csv(to_csv, 'genre_recommendations.csv')
```

# System II: Recommendation Based on IBCF

```{r system2, eval = TRUE}
```

